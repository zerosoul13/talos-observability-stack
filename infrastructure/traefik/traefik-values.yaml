# Traefik Helm Chart Values
# Optimized for local Kubernetes development with Talos

# Deploy as single Deployment on control plane for direct HostPort access
deployment:
  kind: Deployment
  replicas: 1

# Update strategy for DaemonSet with hostNetwork
updateStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 1
    maxSurge: 0

# Node selector to deploy on control plane
nodeSelector:
  node-role.kubernetes.io/control-plane: ""

# Tolerate control plane taint
tolerations:
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule

# Affinity to prefer spreading across worker nodes
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - traefik
        topologyKey: kubernetes.io/hostname

# Use host network for direct port binding
hostNetwork: false

# DNS policy
dnsPolicy: ClusterFirst

# Port configuration
ports:
  # HTTP traffic
  web:
    port: 8000
    exposedPort: 80
    protocol: TCP

  # HTTPS traffic
  websecure:
    port: 8443
    exposedPort: 443
    protocol: TCP

  # Traefik dashboard
  traefik:
    port: 9000
    exposedPort: 9000
    protocol: TCP

# Enable IngressRoute CRD for advanced routing
ingressRoute:
  dashboard:
    enabled: true
    # Don't expose dashboard externally by default
    entryPoints: ["traefik"]
    # We'll create a separate IngressRoute for external access

# Providers configuration
providers:
  # Enable Kubernetes Ingress support
  kubernetesIngress:
    enabled: true
    publishedService:
      enabled: false

  # Enable Kubernetes CRD support (IngressRoute, Middleware, etc.)
  kubernetesCRD:
    enabled: true
    allowCrossNamespace: true
    allowExternalNameServices: true

# Logging configuration
logs:
  general:
    level: INFO
    format: common

  access:
    enabled: true
    format: common
    # Filters removed - not supported in newer Traefik versions
    # All requests will be logged

# Metrics (for Prometheus scraping)
metrics:
  prometheus:
    entryPoint: traefik
    addEntryPointsLabels: true
    addRoutersLabels: true
    addServicesLabels: true

# Resource limits and requests
resources:
  requests:
    cpu: "100m"
    memory: "128Mi"
  limits:
    cpu: "500m"
    memory: "256Mi"

# Health checks
ping:
  enabled: true
  entryPoint: traefik

# Global arguments
additionalArguments:
  - "--api.insecure=true"
  - "--api.dashboard=true"
  - "--ping=true"
  - "--providers.kubernetesingress.ingressclass=traefik"
  - "--providers.kubernetescrd.allowCrossNamespace=true"

# Service configuration
service:
  enabled: true
  type: NodePort
  annotations: {}
  nodePorts:
    web: 30080
    websecure: 30443

# Security context
securityContext:
  capabilities:
    drop:
      - ALL
    add:
      - NET_BIND_SERVICE
  readOnlyRootFilesystem: true
  runAsGroup: 65532
  runAsNonRoot: true
  runAsUser: 65532

podSecurityContext:
  fsGroup: 65532
  seccompProfile:
    type: RuntimeDefault

# Persistence for SSL certificates and acme.json
persistence:
  enabled: false

# Environment variables
env: []

# Additional volumes
volumes: []

# Additional volumeMounts
volumeMounts: []
